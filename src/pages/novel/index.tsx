import { useRouter } from "next/router";
import { useEffect, useState, useRef } from "react";
import styles from "./index.module.css";
import NovelHeader from "@/component/novel/novelHeader/novelHeader";
import NovelFooter from "@/component/novel/novelFooter/novelFooter";
import Content from "@/component/novel/content/content";
import { getNovelStory } from "@/api/api";
import { Option, StoryIndex, StoryType, defaultOptions } from "@/types";
import "react-toastify/dist/ReactToastify.css";
import { toast, ToastContainer } from "react-toastify";

type Props = {};

const withOptionStoryIndex = [
  StoryIndex.Story2,
  StoryIndex.Story3,
  StoryIndex.Story5,
];

export default function Novel({}: Props) {
  const router = useRouter();
  const toastId = useRef(null);
  const queryStoryIndex = router.query.storyIndex?.toString() ?? "0";
  const defaultStory: StoryIndex =
    parseInt(queryStoryIndex) ?? StoryIndex.Story1;

  const [invalid, setInvalid] = useState<boolean>(false);

  const [storyIndex, setStoryIndex] = useState<StoryIndex>(defaultStory);
  const [nextStoryTitle, setNextStoryTitle] = useState<string>("");
  const [data, setData] = useState<StoryType>({
    contents: [""],
    title: "",
    withOption: false,
  });

  const withFooter =
    !data?.withOption ||
    (data?.withOption &&
      data?.selected !== undefined &&
      data?.selected != Option.None);

  const onClickOption = (option: Option) => {
    toast.dismiss();
    let beforeOptions =
      JSON.parse(window.localStorage.getItem("xletter_options")) ??
      defaultOptions;
    let email = window.localStorage.getItem("xletter_email");
    // Î®ºÏ†Ä ÏöîÏ≤≠ Î≥¥ÎÇ¥Í≥† Í¥úÏ∞ÆÏúºÎ©¥ Ï†ÄÏû•
    getNovelStory({
      email,
      story: storyIndex + 1,
      option,
    })
      .then((res) => {
        setData({
          ...data,
          contents: [...data.contents, res.content],
          selected: option,
        });
        // localstorage update
        if (storyIndex === StoryIndex.Story2) {
          beforeOptions[0] = option;
        } else if (storyIndex === StoryIndex.Story3) {
          beforeOptions[1] = option;
        } else {
          beforeOptions[2] = option;
        }
        window.localStorage.setItem(
          "xletter_option",
          JSON.stringify(beforeOptions)
        );
      })
      .catch((e) => {
        // ÏïàÍ¥úÏ∞ÆÏúºÎ©¥ Îã§Î•∏ ÏòµÏÖò ÏÑ†ÌÉùÌñàÎã§Îäî Î©îÏãúÏßÄ

        toast.error("Ïïó, ÏÑ†ÌÉùÏßÄ Î≥ÄÍ≤ΩÏùÄ Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§üò•", {
          position: toast.POSITION.BOTTOM_CENTER,
          toastId: "invalid_option",
          hideProgressBar: true,
          autoClose: 3000,
          className: `${styles.toast_container}`,
          bodyClassName: "",
          closeButton: false,
          icon: false,
        });
      });

    console.log("after", beforeOptions);
  };

  const getStoryBefore = () => {
    if (storyIndex > StoryIndex.Story1) setStoryIndex(storyIndex - 1);
    window.scrollTo(0, 0);
  };

  const getStoryNext = () => {
    if (storyIndex < StoryIndex.Story5) setStoryIndex(storyIndex + 1);
    window.scrollTo(0, 0);
  };

  const goSurvey = () => {
    console.log(storyIndex);
    router.push("/survey", {
      query: {
        storyIndex,
      },
    });
    window.scrollTo(0, 0);
  };

  useEffect(() => {
    let email = window.localStorage.getItem("xletter_email");
    let myOptions = JSON.parse(window.localStorage.getItem("xletter_option"));
    if (myOptions === null) {
      window.localStorage.setItem(
        "xletter_option",
        JSON.stringify(defaultOptions)
      );
      myOptions = defaultOptions;
    }
    console.log("myOptions", myOptions, "storyIndex", storyIndex);
    // 1. Ï≤´ Î≤àÏß∏ ÌååÌä∏ Ìò∏Ï∂ú
    getNovelStory({
      email,
      story: storyIndex + 1,
      option: Option.None,
    })
      .then((res) => {
        console.log("Ï≤´ Î≤àÏß∏ ÌååÌä∏ Ìò∏Ï∂ú", res);
        // 1.1 ÏÑ†ÌÉùÏßÄ ÏûàÎäî Ìôî-Îã§Ïùå ÏòµÏÖòÏóê Îî∞Îùº
        if (withOptionStoryIndex.includes(storyIndex)) {
          let selected =
            storyIndex === StoryIndex.Story2
              ? myOptions[0]
              : storyIndex === StoryIndex.Story3
              ? myOptions[1]
              : myOptions[2];
          //// None: pass
          if (selected === Option.None) {
            setData({
              contents: [res.content],
              title: res.title,
              withOption: true,
              options: [
                {
                  optionId: Option.A,
                  optionText: res.optionAText,
                  optionValue: Option.A,
                },
                {
                  optionId: Option.B,
                  optionText: res.optionBText,
                  optionValue: Option.B,
                },
              ],
            });
          }
          //// A : Ìò∏Ï∂ú - ÏóêÎü¨ ÏóÜÏúºÎ©¥ ÏÑ∏ÌåÖÌïòÍ≥† ÏóêÎü¨ ÏûàÏúºÎ©¥ BÎ°ú ÏÑ∏ÌåÖ
          else if (selected === Option.A) {
            getNovelStory({
              email,
              story: storyIndex + 1,
              option: selected,
            })
              .then((secondStory) => {
                setData({
                  contents: [res.content, secondStory.content],
                  title: res.title,
                  withOption: true,
                  options: [
                    {
                      optionId: Option.A,
                      optionText: res.optionAText,
                      optionValue: Option.A,
                    },
                    {
                      optionId: Option.B,
                      optionText: res.optionBText,
                      optionValue: Option.B,
                    },
                  ],
                  selected,
                });
              })
              .catch((e) => {
                // Îã§Î•∏ ÏÑ†ÌÉùÏßÄ Í≥®ÎûêÏóàÎã§Îäî Î©îÏãúÏßÄ
                getNovelStory({
                  email,
                  story: storyIndex + 1,
                  option: Option.B,
                }).then((realStory) => {
                  setData({
                    contents: [res.content, realStory.content],
                    title: res.title,
                    withOption: true,
                    options: [
                      {
                        optionId: Option.A,
                        optionText: res.optionAText,
                        optionValue: Option.A,
                      },
                      {
                        optionId: Option.B,
                        optionText: res.optionBText,
                        optionValue: Option.B,
                      },
                    ],
                    selected: Option.B,
                  });
                });
              });
          }
          //// B : Ìò∏Ï∂ú - ÏóêÎü¨ ÏóÜÏúºÎ©¥ ÏÑ∏ÌåÖÌïòÍ≥† ÏóêÎü¨ ÏûàÏúºÎ©¥ AÎ°ú ÏÑ∏ÌåÖ
          else {
            getNovelStory({
              email,
              story: storyIndex + 1,
              option: Option.None,
            })
              .then((secondStory) => {
                setData({
                  contents: [res.content, secondStory.content],
                  title: res.title,
                  withOption: true,
                  options: [
                    {
                      optionId: Option.A,
                      optionText: res.optionAText,
                      optionValue: Option.A,
                    },
                    {
                      optionId: Option.B,
                      optionText: res.optionBText,
                      optionValue: Option.B,
                    },
                  ],
                  selected,
                });
              })
              .catch((e) => {
                // Îã§Î•∏ ÏÑ†ÌÉùÏßÄ Í≥®ÎûêÏóàÎã§Îäî Î©îÏãúÏßÄ
                getNovelStory({
                  email,
                  story: storyIndex + 1,
                  option: Option.B,
                }).then((realStory) => {
                  setData({
                    contents: [res.content, realStory.content],
                    title: res.title,
                    withOption: true,
                    options: [
                      {
                        optionId: Option.A,
                        optionText: res.optionAText,
                        optionValue: Option.A,
                      },
                      {
                        optionId: Option.B,
                        optionText: res.optionBText,
                        optionValue: Option.B,
                      },
                    ],
                    selected: Option.B,
                  });
                });
              });
          }
        }
        // 1.2 ÏÑ†ÌÉùÏßÄ ÏóÜÎäî Ìôî
        else {
          setData({
            contents: [res.content],
            title: res.title,
            withOption: false,
          });
        }

        // 2. Îã§Ïùå Ìôî Ï†úÎ™© Ìò∏Ï∂ú
        if (storyIndex != StoryIndex.Story5) {
          getNovelStory({
            email,
            story: storyIndex + 2,
            option: Option.None,
          }).then((nextStory) => {
            setNextStoryTitle(nextStory.title);
          });
        }

        // 3. Îß® ÏúÑÎ°ú Ïù¥Îèô
        window.scrollTo(0, 0);
      })
      .catch((e) => {
        // ÏÇ¨Ï†ÑÎì±Î°ù Ïïà Ìïú Î©îÏùº Í≤ΩÍ≥†
        setInvalid(true);
      });
  }, [storyIndex]);

  if (invalid) {
    return <div className={styles.invalid}>invalid</div>;
  } else {
    return (
      <div className={styles.container}>
        <NovelHeader
          novelTitle="ÏúÑÌóòÌïú Ïù∏ÌÑ∞Î∑∞ by Ï≤≠Î™ΩÏ±ÑÌôî"
          storyTitle={`${storyIndex + 1}. ${data?.title}`}
          storyIndex={storyIndex}
          getStoryBefore={getStoryBefore}
          getStoryNext={getStoryNext}
        />
        {storyIndex === StoryIndex.Story1 && (
          <div className={styles.content_warning}>
            <div>
              <div className={styles.content_warning_title}>ÎìúÎ¶¨Îäî ÎßêÏîÄ </div>
              <div className={styles.content_warning_content}>
                Î≥∏ ÏÜåÏÑ§ ‚ÄòÏúÑÌóòÌïú Ïù∏ÌÑ∞Î∑∞‚ÄôÎäî Ìïú Ïó∞ÏòàÏù∏Ïùò Ïö∞Ïö∏Í≥º ÏûêÏÇ¥ÏùÑ ÏÜåÏû¨Î°ú ÌïòÍ≥†
                ÏûàÏäµÎãàÎã§. <br />
                Ïù¥Îü¨Ìïú ÏÜåÏû¨Î•º Îã§Î£®Îäî Îç∞Ïóê ÏûàÏñ¥ ÎàÑÍµ¨ÏóêÍ≤åÎèÑ ÏÉÅÏ≤òÍ∞Ä ÎêòÏßÄ ÏïäÏùÑ Ïàò
                ÏûàÎèÑÎ°ù ÏûëÍ∞ÄÎãòÍ≥º X-LetterÌåÄ Î™®ÎëêÍ∞Ä Í≥†ÎØºÏùÑ Í±∞Îì≠ÌñàÏäµÎãàÎã§. <br />Ïù¥
                ÏûëÌíàÏùÄ Ï≤≠Î™ΩÏ±ÑÌôî ÏûëÍ∞ÄÎãòÍªòÏÑú 2016ÎÖÑÏóê Íµ¨ÏÉÅÌïòÏã† ÌõÑ Ìïú Î≤àÎèÑ Î∞úÌëúÎêú
                Ï†Å ÏóÜÎäî ÎÇ¥Ïö©ÏúºÎ°ú Í∑∏ Ïñ¥Îñ§ Ïã§Ï†ú ÏÇ¨Í±¥Í≥ºÎèÑ Î¨¥Í¥ÄÌïòÎÇò, <br />
                ÌòπÏãúÎùºÎèÑ Ïã¨Î¶¨Ï†ÅÏù∏ ÏòÅÌñ•ÏùÑ Î∞õÏúºÏã§ Ïàò ÏûàÏúºÎãà Í∞êÏÉÅ Ïãú Ïú†ÏùòÌï¥ Ï£ºÏãúÍ≥†
                ÌïÑÏöîÏãú Ï£ºÏúÑÏóê ÎèÑÏõÄÏùÑ ÏöîÏ≤≠ÌïòÏãúÍ∏∏ Î∞îÎûçÎãàÎã§. <br />
              </div>
            </div>
          </div>
        )}
        <div className={styles.novel_container}>
          <div className={styles.novel}>
            <div className={styles.story_title}>{data?.title}</div>
            <div className={styles.novel_content_container}>
              <Content
                storyIndex={storyIndex}
                data={data}
                onSelectOption={onClickOption}
              />
              <div className={styles.toast_wrapper}>
                <ToastContainer limit={1} />
              </div>
            </div>
          </div>
        </div>
        {withFooter && (
          <NovelFooter
            isLastStory={storyIndex === StoryIndex.Story5}
            getStoryNext={getStoryNext}
            goSurvey={goSurvey}
            nextStoryIndex={storyIndex + 2}
            nextStoryTitle={nextStoryTitle}
            storyIndex={storyIndex}
          />
        )}
      </div>
    );
  }
}
